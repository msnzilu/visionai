name: Deploy to AWS Docker Swarm

on:
  push:
    branches:
      - main
      - production
  pull_request:
    branches:
      - main
      - production
  workflow_dispatch:

env:
  AWS_REGION: eu-north-1
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  SWARM_MANAGER_HOST: ${{ secrets.SWARM_MANAGER_HOST }}
  SWARM_MANAGER_USER: ubuntu

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    strategy:
      matrix:
        service: [backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Ensure ECR Repository Exists
        run: |
          REPO_NAME=visionai-${{ matrix.service }}
          aws ecr describe-repositories --repository-names ${REPO_NAME} --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository --repository-name ${REPO_NAME} --region ${{ env.AWS_REGION }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/visionai-${{ matrix.service }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service == 'automation' && 'browser-automation' || matrix.service }}
          file: ./docker/${{ matrix.service }}.Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Image digest
        run: echo ${{ steps.meta.outputs.digest }}

  deploy:
    name: Deploy to Docker Swarm
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SWARM_SSH_PRIVATE_KEY }}" > ~/.ssh/swarm_key
          chmod 600 ~/.ssh/swarm_key
          ssh-keyscan -H ${{ env.SWARM_MANAGER_HOST }} >> ~/.ssh/known_hosts

      - name: Set image tag
        id: set-tag
        run: |
          if [ "${{ github.ref }}" == "refs/heads/production" ]; then
            echo "IMAGE_TAG=production" >> $GITHUB_OUTPUT
          else
            echo "IMAGE_TAG=main-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Swarm
        env:
          IMAGE_TAG: ${{ steps.set-tag.outputs.IMAGE_TAG }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
        run: |
          # Copy docker-compose file to manager
          scp -o StrictHostKeyChecking=no -i ~/.ssh/swarm_key \
            docker-compose.swarm.yml \
            ${{ env.SWARM_MANAGER_USER }}@${{ env.SWARM_MANAGER_HOST }}:/tmp/

          # Deploy stack
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/swarm_key \
            ${{ env.SWARM_MANAGER_USER }}@${{ env.SWARM_MANAGER_HOST }} << 'EOF'
            
            # Helper function to create secret if missing
            create_secret() {
              local name=$1
              local value=$2
              if ! docker secret ls | grep -q "$name"; then
                echo "Creating secret: $name"
                echo "$value" | docker secret create "$name" -
              else
                echo "Secret $name already exists (skipping)"
              fi
            }

            # Create secrets from env vars
            create_secret "OPENAI_API_KEY" "${OPENAI_API_KEY}"
            create_secret "STRIPE_SECRET_KEY" "${STRIPE_API_KEY}"
            create_secret "JWT_SECRET_KEY" "${JWT_SECRET}"
            create_secret "GOOGLE_CLIENT_ID" "${GOOGLE_CLIENT_ID}"
            create_secret "GOOGLE_CLIENT_SECRET" "${GOOGLE_CLIENT_SECRET}"
            
            # Check disk space before cleanup
            echo "=== Disk Space Before Cleanup ==="
            df -h
            docker system df

            # Aggressive cleanup
            echo "Cleaning up..."
            docker system prune -af --volumes
            sudo apt-get clean
            sudo rm -rf /var/lib/apt/lists/*
            
            # Check disk space after cleanup
            echo "=== Disk Space After Cleanup ==="
            df -h

            # Set environment variables for stack deploy
            export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
            export IMAGE_TAG=${{ steps.set-tag.outputs.IMAGE_TAG }}
            
            # Login to ECR
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}
            
            # Deploy stack with rolling update
            docker stack deploy \
              --compose-file /tmp/docker-compose.swarm.yml \
              --with-registry-auth \
              visionai
            
            # Wait for services to be updated
            echo "Waiting for services to update..."
            sleep 30
            
            # Check service status
            docker service ls
            
            # Check for failed services
            FAILED=$(docker service ls --filter "label=com.docker.stack.namespace=visionai" --format "{{.Replicas}}" | grep "0/")
            if [ ! -z "$FAILED" ]; then
              echo "Some services failed to start!"
              docker service ls
              exit 1
            fi
            
            echo "Deployment successful!"
          EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/swarm_key \
            ${{ env.SWARM_MANAGER_USER }}@${{ env.SWARM_MANAGER_HOST }} << 'EOF'
            
            # Check stack tasks (running/failed)
            echo "=== Stack Tasks ==="
            docker stack ps visionai --no-trunc

            # Check node status
            echo "=== Node Status ==="
            docker node ls
            
            # Check disk space
            echo "=== Disk Space ==="
            df -h
            
            # Check service logs for errors
            echo "=== Recent Backend Logs ==="
            docker service logs --tail 50 visionai_backend
            
            echo "=== Recent Traefik Logs ==="
            docker service logs --tail 50 visionai_traefik
            
            # Verify internal health (bypass firewall/DNS)
            echo "=== Internal Health Check ==="
            curl -v -k --connect-timeout 10 https://127.0.0.1/api/v1/health || echo "Internal Check Failed"

            # Verify health endpoints (external)
            echo "=== External Health Check ==="
            sleep 10
            curl -f --connect-timeout 10 https://webtestingdomain.online/api/v1/health || exit 1
            
            echo "All services are healthy!"
          EOF

      - name: Rollback on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/swarm_key \
            ${{ env.SWARM_MANAGER_USER }}@${{ env.SWARM_MANAGER_HOST }} << 'EOF'
            
            echo "Deployment failed! Rolling back..."
            
            # Rollback all services
            for service in $(docker service ls --filter "label=com.docker.stack.namespace=visionai" --format "{{.Name}}"); do
              echo "Rolling back $service..."
              docker service rollback $service
            done
            
            echo "Rollback complete!"
          EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/swarm_key

  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "✅ Deployment to webtestingdomain.online successful!"
          else
            echo "❌ Deployment failed!"
          fi
