<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Apply Dashboard - Vision.AI</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .auto-apply-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #10b981;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            left: 33px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }

        .stat-trend {
            font-size: 0.875rem;
            color: #10b981;
            margin-top: 0.5rem;
        }

        .cv-data-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }

        .cv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .cv-field {
            margin-bottom: 1rem;
        }

        .cv-field-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .cv-field-value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 500;
        }

        .skills-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .skill-tag {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .matching-jobs-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .job-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        .job-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .job-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
        }

        .job-company {
            font-size: 1rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .match-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
        }

        .score-high {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .score-medium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .score-low {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .score-label {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .job-details {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .job-detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .job-description {
            font-size: 0.875rem;
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .job-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-apply {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-apply.auto-applied {
            background: #10b981;
            cursor: default;
        }

        .btn-view {
            padding: 0.75rem 1.5rem;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-view:hover {
            background: #667eea;
            color: white;
        }

        .settings-panel {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .slider-container {
            flex: 1;
            max-width: 300px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div>
                <h1>Auto-Apply Dashboard</h1>
                <p style="color: #6b7280; margin-top: 0.5rem;">AI-powered automatic job applications</p>
            </div>
            <div class="auto-apply-toggle">
                <span>Auto-Apply</span>
                <div class="toggle-switch" id="autoApplyToggle" onclick="toggleAutoApply()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Auto-Applications Today</div>
                <div class="stat-value" id="todayApplications">0</div>
                <div class="stat-trend">‚Üë Limit: <span id="dailyLimit">5</span>/day</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Auto-Applications</div>
                <div class="stat-value" id="totalApplications">0</div>
                <div class="stat-trend">All time</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Average Match Score</div>
                <div class="stat-value" id="avgMatchScore">0%</div>
                <div class="stat-trend">Quality indicator</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Interview Rate</div>
                <div class="stat-value" id="interviewRate">0%</div>
                <div class="stat-trend">From auto-applications</div>
            </div>
        </div>

        <!-- CV Data Section -->
        <div class="cv-data-section">
            <h2 class="section-title">üìÑ Your CV Profile</h2>
            <div id="cvDataContainer" class="loading">
                <div class="spinner"></div>
                <p>Loading CV data...</p>
            </div>
        </div>

        <!-- Auto-Apply Settings -->
        <div class="cv-data-section" id="settingsSection" style="display: none;">
            <h2 class="section-title">‚öôÔ∏è Auto-Apply Settings</h2>
            <div class="settings-panel">
                <div class="settings-row">
                    <div>
                        <strong>Max Applications Per Day</strong>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                            Limit daily auto-applications to protect your reputation
                        </p>
                    </div>
                    <div class="slider-container">
                        <input type="range" min="1" max="10" value="5" class="slider" id="maxApplicationsSlider">
                        <div style="text-align: center; margin-top: 0.5rem; font-weight: bold;">
                            <span id="maxApplicationsValue">5</span> applications/day
                        </div>
                    </div>
                </div>
                <div class="settings-row">
                    <div>
                        <strong>Minimum Match Score</strong>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                            Only apply to jobs with this match score or higher
                        </p>
                    </div>
                    <div class="slider-container">
                        <input type="range" min="50" max="90" value="70" class="slider" id="minScoreSlider">
                        <div style="text-align: center; margin-top: 0.5rem; font-weight: bold;">
                            <span id="minScoreValue">70</span>% minimum
                        </div>
                    </div>
                </div>
                <button class="btn-apply" onclick="saveSettings()" style="margin-top: 1rem;">
                    Save Settings
                </button>
            </div>
        </div>

        <!-- Matching Jobs Section -->
        <div class="matching-jobs-section">
            <h2 class="section-title">üéØ Matching Jobs (AI-Scored)</h2>
            <div id="matchingJobsContainer" class="loading">
                <div class="spinner"></div>
                <p>Finding matching jobs...</p>
            </div>
        </div>
    </div>

    <script src="/assets/js/auth.js"></script>
    <script>
        let currentUser = null;
        let autoApplyEnabled = false;

        // Initialize page
        async function initializePage() {
            currentUser = await getCurrentUser();
            if (!currentUser) {
                window.location.href = '/login.html';
                return;
            }

            await loadCVData();
            await loadStats();
            await loadMatchingJobs();
            await loadSettings();
        }

        // Load CV data
        async function loadCVData() {
            try {
                const response = await fetch('/api/v1/users/me', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                const data = await response.json();
                const cvData = data.cv_parsed || {};

                const cvHTML = `
                    <div class="cv-grid">
                        <div>
                            <div class="cv-field">
                                <div class="cv-field-label">Full Name</div>
                                <div class="cv-field-value">${data.full_name || 'Not provided'}</div>
                            </div>
                            <div class="cv-field">
                                <div class="cv-field-label">Email</div>
                                <div class="cv-field-value">${data.email || 'Not provided'}</div>
                            </div>
                            <div class="cv-field">
                                <div class="cv-field-label">Phone</div>
                                <div class="cv-field-value">${cvData.phone || 'Not provided'}</div>
                            </div>
                            <div class="cv-field">
                                <div class="cv-field-label">Location</div>
                                <div class="cv-field-value">${cvData.location || 'Not provided'}</div>
                            </div>
                        </div>
                        <div>
                            <div class="cv-field">
                                <div class="cv-field-label">Years of Experience</div>
                                <div class="cv-field-value">${cvData.years_of_experience || 0} years</div>
                            </div>
                            <div class="cv-field">
                                <div class="cv-field-label">Education Level</div>
                                <div class="cv-field-value">${cvData.education_level || 'Not provided'}</div>
                            </div>
                            <div class="cv-field">
                                <div class="cv-field-label">Current/Last Role</div>
                                <div class="cv-field-value">${cvData.current_role || 'Not provided'}</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 2rem;">
                        <div class="cv-field-label">Skills</div>
                        <div class="skills-container">
                            ${(cvData.skills || []).map(skill => `
                                <span class="skill-tag">${skill}</span>
                            `).join('')}
                        </div>
                    </div>
                    <div style="margin-top: 2rem;">
                        <div class="cv-field-label">Professional Summary</div>
                        <div class="cv-field-value" style="line-height: 1.6;">
                            ${cvData.summary || 'No summary available'}
                        </div>
                    </div>
                `;

                document.getElementById('cvDataContainer').innerHTML = cvHTML;
            } catch (error) {
                console.error('Error loading CV data:', error);
                document.getElementById('cvDataContainer').innerHTML = `
                    <p style="color: #ef4444;">Error loading CV data. Please upload your CV first.</p>
                `;
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/v1/applications/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                const stats = await response.json();

                // Calculate today's auto-applications
                const today = new Date().toISOString().split('T')[0];
                const todayApps = stats.applications_by_date?.[today]?.auto_applied || 0;

                document.getElementById('todayApplications').textContent = todayApps;
                document.getElementById('totalApplications').textContent = stats.total_auto_applications || 0;
                document.getElementById('avgMatchScore').textContent =
                    Math.round((stats.avg_match_score || 0) * 100) + '%';
                document.getElementById('interviewRate').textContent =
                    Math.round((stats.interview_rate || 0) * 100) + '%';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load matching jobs
        async function loadMatchingJobs() {
            try {
                const response = await fetch('/api/v1/jobs/matching?limit=10', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                const jobs = await response.json();

                if (!jobs || jobs.length === 0) {
                    document.getElementById('matchingJobsContainer').innerHTML = `
                        <p style="text-align: center; color: #6b7280;">No matching jobs found. Check back later!</p>
                    `;
                    return;
                }

                const jobsHTML = jobs.map(job => {
                    const score = job.match_score || 0;
                    const scoreClass = score >= 0.8 ? 'score-high' : score >= 0.6 ? 'score-medium' : 'score-low';
                    const isApplied = job.applied || false;

                    return `
                        <div class="job-card">
                            <div class="job-header">
                                <div>
                                    <div class="job-title">${job.title}</div>
                                    <div class="job-company">${job.company}</div>
                                </div>
                                <div class="match-score">
                                    <div class="score-circle ${scoreClass}">
                                        ${Math.round(score * 100)}%
                                    </div>
                                    <div class="score-label">Match</div>
                                </div>
                            </div>
                            <div class="job-details">
                                <div class="job-detail-item">
                                    üìç ${job.location || 'Remote'}
                                </div>
                                <div class="job-detail-item">
                                    üí∞ ${job.salary || 'Not specified'}
                                </div>
                                <div class="job-detail-item">
                                    ‚è∞ Posted ${getTimeAgo(job.created_at)}
                                </div>
                            </div>
                            <div class="job-description">
                                ${truncate(job.description, 200)}
                            </div>
                            <div class="job-actions">
                                <button class="btn-apply ${isApplied ? 'auto-applied' : ''}" 
                                        onclick="${isApplied ? '' : `manualApply('${job._id}')`}"
                                        ${isApplied ? 'disabled' : ''}>
                                    ${isApplied ? '‚úì Auto-Applied' : 'Apply Now'}
                                </button>
                                <button class="btn-view" onclick="viewJob('${job._id}')">
                                    View Details
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('matchingJobsContainer').innerHTML = jobsHTML;
            } catch (error) {
                console.error('Error loading matching jobs:', error);
                document.getElementById('matchingJobsContainer').innerHTML = `
                    <p style="color: #ef4444;">Error loading jobs. Please try again later.</p>
                `;
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/v1/users/me', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                const data = await response.json();
                const preferences = data.preferences || {};

                autoApplyEnabled = preferences.auto_apply_enabled || false;
                const maxApps = preferences.max_daily_applications || 5;
                const minScore = Math.round((preferences.min_match_score || 0.7) * 100);

                // Update UI
                const toggle = document.getElementById('autoApplyToggle');
                if (autoApplyEnabled) {
                    toggle.classList.add('active');
                    document.getElementById('settingsSection').style.display = 'block';
                }

                document.getElementById('maxApplicationsSlider').value = maxApps;
                document.getElementById('maxApplicationsValue').textContent = maxApps;
                document.getElementById('dailyLimit').textContent = maxApps;

                document.getElementById('minScoreSlider').value = minScore;
                document.getElementById('minScoreValue').textContent = minScore;

            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Toggle auto-apply
        async function toggleAutoApply() {
            const toggle = document.getElementById('autoApplyToggle');
            autoApplyEnabled = !autoApplyEnabled;

            if (autoApplyEnabled) {
                toggle.classList.add('active');
                document.getElementById('settingsSection').style.display = 'block';
            } else {
                toggle.classList.remove('active');
                document.getElementById('settingsSection').style.display = 'none';
            }

            // Save to backend
            try {
                await fetch('/api/v1/users/preferences', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        auto_apply_enabled: autoApplyEnabled
                    })
                });

                showNotification(autoApplyEnabled ? 'Auto-apply enabled!' : 'Auto-apply disabled');
            } catch (error) {
                console.error('Error toggling auto-apply:', error);
                showNotification('Error updating settings', 'error');
            }
        }

        // Save settings
        async function saveSettings() {
            const maxApps = parseInt(document.getElementById('maxApplicationsSlider').value);
            const minScore = parseInt(document.getElementById('minScoreSlider').value) / 100;

            try {
                await fetch('/api/v1/users/preferences', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        max_daily_applications: maxApps,
                        min_match_score: minScore
                    })
                });

                document.getElementById('dailyLimit').textContent = maxApps;
                showNotification('Settings saved successfully!');
            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Error saving settings', 'error');
            }
        }

        // Update slider values
        document.getElementById('maxApplicationsSlider')?.addEventListener('input', (e) => {
            document.getElementById('maxApplicationsValue').textContent = e.target.value;
        });

        document.getElementById('minScoreSlider')?.addEventListener('input', (e) => {
            document.getElementById('minScoreValue').textContent = e.target.value;
        });

        // Helper functions
        function truncate(text, length) {
            if (!text) return '';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function getTimeAgo(date) {
            if (!date) return 'recently';
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };

            for (const [name, seconds_in_interval] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / seconds_in_interval);
                if (interval >= 1) {
                    return `${interval} ${name}${interval > 1 ? 's' : ''} ago`;
                }
            }
            return 'just now';
        }

        function manualApply(jobId) {
            window.location.href = `/jobs/${jobId}`;
        }

        function viewJob(jobId) {
            window.location.href = `/jobs/${jobId}`;
        }

        function showNotification(message, type = 'success') {
            // Simple notification - you can enhance this
            alert(message);
        }

        // Initialize on page load
        initializePage();
    </script>

    <!-- Chatbot -->
    <link rel="stylesheet" href="/assets/css/chatbot.css">
    <script src="/assets/js/chatbot.js"></script>
</body>

</html>